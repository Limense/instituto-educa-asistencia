<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Asistencia - Instituto Educa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/theme-educa.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .reports-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .filter-control {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .report-card h3 {
            color: var(--color-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            position: relative;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--color-light);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--color-text-light);
            font-size: 0.9rem;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--color-light);
            font-weight: bold;
            color: var(--color-text);
        }

        .data-table tr:hover {
            background: var(--color-light);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-present {
            background: var(--color-success);
            color: white;
        }

        .status-absent {
            background: var(--color-danger);
            color: white;
        }

        .status-late {
            background: var(--color-warning);
            color: white;
        }

        .status-incomplete {
            background: var(--color-info);
            color: white;
        }

        .export-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .quick-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-primary);
        }

        .quick-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .quick-stat-label {
            color: var(--color-text-light);
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .reports-container {
                padding: 10px;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <!-- Header -->
        <div class="reports-header">
            <h1><i class="fas fa-chart-bar"></i> Reportes de Asistencia</h1>
            <p>Análisis y estadísticas detalladas del sistema de asistencia</p>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <h2><i class="fas fa-filter"></i> Filtros de Reporte</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="reportType">Tipo de Reporte:</label>
                    <select class="filter-control" id="reportType">
                        <option value="general">Reporte General</option>
                        <option value="individual">Reporte Individual</option>
                        <option value="department">Por Departamento</option>
                        <option value="comparative">Comparativo</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="userSelect">Usuario:</label>
                    <select class="filter-control" id="userSelect">
                        <option value="">Todos los usuarios</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="departmentSelect">Departamento:</label>
                    <select class="filter-control" id="departmentSelect">
                        <option value="">Todos los departamentos</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="dateRange">Período:</label>
                    <select class="filter-control" id="dateRange">
                        <option value="today">Hoy</option>
                        <option value="week">Esta Semana</option>
                        <option value="month">Este Mes</option>
                        <option value="quarter">Este Trimestre</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label for="startDate">Fecha Inicio:</label>
                    <input type="date" class="filter-control" id="startDate">
                </div>

                <div class="filter-group" id="customDateGroup2" style="display: none;">
                    <label for="endDate">Fecha Fin:</label>
                    <input type="date" class="filter-control" id="endDate">
                </div>
            </div>

            <div class="filter-buttons">
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-search"></i> Generar Reporte
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-eraser"></i> Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- Estadísticas rápidas -->
        <div class="quick-stats" id="quickStats" style="display: none;">
            <div class="quick-stat-card">
                <div class="quick-stat-value" id="totalUsers">0</div>
                <div class="quick-stat-label">Total Usuarios</div>
            </div>
            <div class="quick-stat-card">
                <div class="quick-stat-value" id="presentToday">0</div>
                <div class="quick-stat-label">Presentes Hoy</div>
            </div>
            <div class="quick-stat-card">
                <div class="quick-stat-value" id="averageAttendance">0%</div>
                <div class="quick-stat-label">Promedio Asistencia</div>
            </div>
            <div class="quick-stat-card">
                <div class="quick-stat-value" id="totalHours">0</div>
                <div class="quick-stat-label">Horas Totales</div>
            </div>
        </div>

        <!-- Reportes visuales -->
        <div class="reports-grid" id="reportsGrid">
            <!-- Gráfico de asistencia -->
            <div class="report-card">
                <h3><i class="fas fa-chart-line"></i> Tendencia de Asistencia</h3>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <!-- Gráfico por departamento -->
            <div class="report-card">
                <h3><i class="fas fa-chart-pie"></i> Asistencia por Departamento</h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

            <!-- Estadísticas generales -->
            <div class="report-card">
                <h3><i class="fas fa-chart-bar"></i> Estadísticas del Período</h3>
                <div class="stats-grid" id="periodStats">
                    <div class="stat-item">
                        <div class="stat-value" id="periodDays">0</div>
                        <div class="stat-label">Días Laborables</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="periodPresent">0</div>
                        <div class="stat-label">Días Presente</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="periodLate">0</div>
                        <div class="stat-label">Llegadas Tardías</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="periodOvertime">0</div>
                        <div class="stat-label">Horas Extra</div>
                    </div>
                </div>
            </div>

            <!-- Top usuarios -->
            <div class="report-card">
                <h3><i class="fas fa-trophy"></i> Mejor Asistencia</h3>
                <div id="topUsers"></div>
            </div>
        </div>

        <!-- Tabla de datos detallados -->
        <div class="table-container">
            <h2><i class="fas fa-table"></i> Datos Detallados</h2>
            <div id="loadingIndicator" class="loading" style="display: none;">
                <i class="fas fa-spinner"></i>
                <p>Generando reporte...</p>
            </div>
            <div id="noDataIndicator" class="no-data" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <p>No hay datos para mostrar con los filtros seleccionados</p>
            </div>
            <div id="tableContainer" style="display: none;">
                <table class="data-table" id="reportTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sección de exportación -->
        <div class="export-section">
            <h2><i class="fas fa-download"></i> Exportar Reporte</h2>
            <p>Descarga los datos en diferentes formatos para análisis externo</p>
            <div class="export-buttons">
                <button class="btn btn-success" onclick="exportReport('csv')">
                    <i class="fas fa-file-csv"></i> Exportar CSV
                </button>
                <button class="btn btn-primary" onclick="exportReport('json')">
                    <i class="fas fa-file-code"></i> Exportar JSON
                </button>
                <button class="btn btn-secondary" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button class="btn btn-primary" onclick="shareToGoogleSheets()">
                    <i class="fab fa-google"></i> Google Sheets
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/data-factory.js"></script>
    <script src="../js/event-bus.js"></script>
    <script src="../js/services.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>
    <script>
        let currentUser = null;
        let reportData = null;
        let attendanceChart = null;
        let departmentChart = null;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                window.location.href = '../index.html';
                return;
            }

            // Verificar permisos
            if (!UserManager.hasPermission(currentUser.id, 'view_reports') && 
                !UserManager.hasPermission(currentUser.id, 'all_permissions')) {
                alert('No tiene permisos para ver reportes');
                window.history.back();
                return;
            }

            initializePage();
        });

        function initializePage() {
            loadUsers();
            loadDepartments();
            setupDateHandlers();
            generateReport(); // Cargar reporte inicial
        }

        function loadUsers() {
            const select = document.getElementById('userSelect');
            const users = UserManager.getAllUsers().filter(u => u.active);
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.profile.firstName} ${user.profile.lastName}`;
                select.appendChild(option);
            });
        }

        function loadDepartments() {
            const select = document.getElementById('departmentSelect');
            const departments = [...new Set(UserManager.getAllUsers()
                .map(u => u.employment.department)
                .filter(d => d))];
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        function setupDateHandlers() {
            const dateRange = document.getElementById('dateRange');
            const customDateGroup = document.getElementById('customDateGroup');
            const customDateGroup2 = document.getElementById('customDateGroup2');

            dateRange.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                customDateGroup.style.display = isCustom ? 'block' : 'none';
                customDateGroup2.style.display = isCustom ? 'block' : 'none';
            });

            // Establecer fechas por defecto
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function getDateRange() {
            const range = document.getElementById('dateRange').value;
            const today = new Date();
            let startDate, endDate;

            switch (range) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'custom':
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
                    break;
                default:
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
            }

            return { startDate, endDate };
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const userId = document.getElementById('userSelect').value;
            const department = document.getElementById('departmentSelect').value;
            const { startDate, endDate } = getDateRange();

            // Mostrar indicador de carga
            showLoading(true);

            try {
                // Generar reporte según el tipo
                if (reportType === 'individual' && userId) {
                    reportData = AttendanceManager.generateReport({
                        userId: userId,
                        startDate: startDate,
                        endDate: endDate
                    });
                } else {
                    reportData = AttendanceManager.generateReport({
                        startDate: startDate,
                        endDate: endDate
                    });

                    // Filtrar por departamento si está seleccionado
                    if (department && reportData.users) {
                        reportData.users = reportData.users.filter(u => 
                            u.employment.department === department
                        );
                    }
                }

                displayReport();
                showLoading(false);
            } catch (error) {
                console.error('Error al generar reporte:', error);
                showNoData(true);
                showLoading(false);
            }
        }

        function displayReport() {
            if (!reportData) {
                showNoData(true);
                return;
            }

            updateQuickStats();
            updateCharts();
            updateTable();
            updateTopUsers();
            
            showNoData(false);
            document.getElementById('tableContainer').style.display = 'block';
        }

        function updateQuickStats() {
            const quickStats = document.getElementById('quickStats');
            
            if (reportData.type === 'individual') {
                document.getElementById('totalUsers').textContent = '1';
                document.getElementById('presentToday').textContent = 
                    reportData.statistics.presentDays || '0';
                document.getElementById('averageAttendance').textContent = 
                    (reportData.statistics.attendanceRate || 0) + '%';
                document.getElementById('totalHours').textContent = 
                    (reportData.statistics.totalHours || 0).toFixed(1);
            } else {
                document.getElementById('totalUsers').textContent = 
                    reportData.summary.totalUsers || '0';
                document.getElementById('presentToday').textContent = 
                    reportData.summary.totalPresentDays || '0';
                document.getElementById('averageAttendance').textContent = 
                    (reportData.summary.averageAttendanceRate || 0) + '%';
                document.getElementById('totalHours').textContent = 
                    reportData.users.reduce((sum, u) => sum + (u.attendanceStats.totalHours || 0), 0).toFixed(1);
            }

            quickStats.style.display = 'grid';
        }

        function updateCharts() {
            updateAttendanceChart();
            updateDepartmentChart();
        }

        function updateAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            if (attendanceChart) {
                attendanceChart.destroy();
            }

            let labels = [];
            let data = [];

            if (reportData.type === 'individual') {
                // Gráfico de tendencia individual
                const records = reportData.records || [];
                labels = records.map(r => r.date);
                data = records.map(r => r.totalHours || 0);
            } else {
                // Gráfico de resumen por departamento
                const deptStats = {};
                reportData.users.forEach(user => {
                    const dept = user.employment.department;
                    if (!deptStats[dept]) {
                        deptStats[dept] = { total: 0, count: 0 };
                    }
                    deptStats[dept].total += user.attendanceStats.attendanceRate || 0;
                    deptStats[dept].count++;
                });

                labels = Object.keys(deptStats);
                data = labels.map(label => 
                    deptStats[label].count > 0 ? 
                    (deptStats[label].total / deptStats[label].count).toFixed(1) : 0
                );
            }

            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: reportData.type === 'individual' ? 'Horas Trabajadas' : 'Promedio Asistencia (%)',
                        data: data,
                        borderColor: 'rgb(242, 121, 131)',
                        backgroundColor: 'rgba(242, 121, 131, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateDepartmentChart() {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            
            if (departmentChart) {
                departmentChart.destroy();
            }

            if (reportData.type === 'individual') {
                // Para reporte individual, mostrar distribución de tiempo
                const user = reportData.user;
                const records = reportData.records || [];
                const totalHours = records.reduce((sum, r) => sum + (r.totalHours || 0), 0);
                const breakHours = records.reduce((sum, r) => sum + (r.breakHours || 0), 0);

                departmentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Horas Trabajadas', 'Tiempo Descanso'],
                        datasets: [{
                            data: [totalHours, breakHours],
                            backgroundColor: [
                                'rgba(242, 121, 131, 0.8)',
                                'rgba(5, 219, 242, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } else {
                // Para reporte general, mostrar por departamento
                const deptData = {};
                reportData.users.forEach(user => {
                    const dept = user.employment.department;
                    deptData[dept] = (deptData[dept] || 0) + 1;
                });

                departmentChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(deptData),
                        datasets: [{
                            data: Object.values(deptData),
                            backgroundColor: [
                                'rgba(242, 121, 131, 0.8)',
                                'rgba(5, 219, 242, 0.8)',
                                'rgba(255, 206, 84, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        function updateTable() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');

            if (reportData.type === 'individual') {
                // Tabla de registros individuales
                header.innerHTML = `
                    <tr>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Horas Trabajadas</th>
                        <th>Tiempo Descanso</th>
                        <th>Observaciones</th>
                    </tr>
                `;

                const records = reportData.records || [];
                body.innerHTML = records.map(record => {
                    const statusBadge = getStatusBadge(record.status);
                    const observations = record.observations.map(obs => obs.message).join(', ') || 'Ninguna';
                    
                    return `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td>${statusBadge}</td>
                            <td>${(record.totalHours || 0).toFixed(1)}h</td>
                            <td>${(record.breakHours || 0).toFixed(1)}h</td>
                            <td>${observations}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Tabla de resumen por usuario
                header.innerHTML = `
                    <tr>
                        <th>Usuario</th>
                        <th>Departamento</th>
                        <th>Días Presente</th>
                        <th>Días Ausente</th>
                        <th>Llegadas Tardías</th>
                        <th>Horas Totales</th>
                        <th>% Asistencia</th>
                    </tr>
                `;

                const users = reportData.users || [];
                body.innerHTML = users.map(user => {
                    const stats = user.attendanceStats;
                    return `
                        <tr>
                            <td>${user.profile.firstName} ${user.profile.lastName}</td>
                            <td>${user.employment.department}</td>
                            <td>${stats.presentDays}</td>
                            <td>${stats.absentDays}</td>
                            <td>${stats.lateDays}</td>
                            <td>${stats.totalHours.toFixed(1)}h</td>
                            <td>${stats.attendanceRate}%</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function updateTopUsers() {
            const container = document.getElementById('topUsers');
            
            if (reportData.type === 'individual') {
                container.innerHTML = '<p class="text-center">Reporte individual seleccionado</p>';
                return;
            }

            const users = reportData.users || [];
            const topUsers = users
                .sort((a, b) => b.attendanceStats.attendanceRate - a.attendanceStats.attendanceRate)
                .slice(0, 5);

            if (topUsers.length === 0) {
                container.innerHTML = '<p class="text-center">No hay datos disponibles</p>';
                return;
            }

            container.innerHTML = topUsers.map((user, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏆';
                return `
                    <div style="display: flex; align-items: center; padding: 10px; margin-bottom: 10px; background: var(--color-light); border-radius: 8px;">
                        <span style="font-size: 1.5rem; margin-right: 15px;">${medal}</span>
                        <div style="flex: 1;">
                            <strong>${user.profile.firstName} ${user.profile.lastName}</strong>
                            <div style="color: var(--color-text-light); font-size: 0.9rem;">
                                ${user.employment.department}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: var(--color-success);">
                                ${user.attendanceStats.attendanceRate}%
                            </div>
                            <div style="font-size: 0.8rem; color: var(--color-text-light);">
                                ${user.attendanceStats.totalHours.toFixed(1)}h
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const statusMap = {
                'present': { text: 'Presente', class: 'status-present' },
                'absent': { text: 'Ausente', class: 'status-absent' },
                'incomplete': { text: 'Incompleto', class: 'status-incomplete' },
                'completed': { text: 'Completado', class: 'status-present' },
                'on-break': { text: 'En Descanso', class: 'status-late' }
            };

            const statusInfo = statusMap[status] || { text: status, class: 'status-incomplete' };
            return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function clearFilters() {
            document.getElementById('reportType').value = 'general';
            document.getElementById('userSelect').value = '';
            document.getElementById('departmentSelect').value = '';
            document.getElementById('dateRange').value = 'month';
            
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            document.getElementById('customDateGroup').style.display = 'none';
            document.getElementById('customDateGroup2').style.display = 'none';
            
            generateReport();
        }

        function exportReport(format) {
            if (!reportData) {
                alert('No hay datos para exportar');
                return;
            }

            try {
                const exportedData = AttendanceManager.exportReport(reportData, format);
                
                if (format === 'csv') {
                    downloadFile(exportedData, 'reporte_asistencia.csv', 'text/csv');
                } else if (format === 'json') {
                    downloadFile(exportedData, 'reporte_asistencia.json', 'application/json');
                } else if (format === 'pdf') {
                    generatePDF();
                }
            } catch (error) {
                alert('Error al exportar: ' + error.message);
            }
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function generatePDF() {
            // Funcionalidad básica de PDF (requeriría una librería como jsPDF)
            alert('Funcionalidad de PDF en desarrollo. Use CSV o JSON por ahora.');
        }

        function shareToGoogleSheets() {
            if (!reportData) {
                alert('No hay datos para compartir');
                return;
            }

            // Preparar datos para Google Sheets
            const csvData = AttendanceManager.exportReport(reportData, 'csv');
            
            // Crear URL para Google Sheets
            const encodedData = encodeURIComponent(csvData);
            const googleSheetsUrl = `https://docs.google.com/spreadsheets/create?usp=sheets_web_ux_initial_state=sheets_home&authuser=0`;
            
            // Abrir en nueva ventana
            window.open(googleSheetsUrl, '_blank');
            
            // Copiar datos al portapapeles
            navigator.clipboard.writeText(csvData).then(() => {
                alert('Datos copiados al portapapeles. Pégalos en la nueva hoja de Google Sheets.');
            }).catch(() => {
                alert('No se pudieron copiar los datos automáticamente. Use Ctrl+C para copiar y Ctrl+V para pegar en Google Sheets.');
            });
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showNoData(show) {
            document.getElementById('noDataIndicator').style.display = show ? 'block' : 'none';
        }

        // Actualizar reporte cuando cambian los filtros
        document.getElementById('reportType').addEventListener('change', function() {
            const userGroup = document.getElementById('userSelect').parentElement;
            userGroup.style.display = this.value === 'individual' ? 'block' : 'none';
        });
    </script>
</body>
</html>
