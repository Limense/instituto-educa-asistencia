<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia - Instituto Educa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/theme-educa.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .attendance-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .attendance-header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .clock-display {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .date-display {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .attendance-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
        }
        
        .action-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .clock-in .action-icon {
            color: #28a745;
        }
        
        .clock-out .action-icon {
            color: #dc3545;
        }
        
        .status .action-icon {
            color: #007bff;
        }
        
        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .attendance-history {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-present {
            background: #d4edda;
            color: #155724;
        }
        
        .status-absent {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-late {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="attendance-container">
        <!-- Header con reloj -->
        <div class="attendance-header">
            <div class="clock-display" id="currentTime">--:--:--</div>
            <div class="date-display" id="currentDate">--</div>
            <p>Sistema de Control de Asistencia</p>
        </div>
        
        <!-- Acciones principales -->
        <div class="attendance-actions">
            <div class="action-card clock-in">
                <i class="fas fa-sign-in-alt action-icon"></i>
                <h3>Marcar Entrada</h3>
                <p>Registra tu hora de entrada</p>
                <button id="clockInBtn" class="btn btn-success" onclick="clockIn()">
                    <i class="fas fa-play"></i> Entrada
                </button>
            </div>
            
            <div class="action-card clock-out">
                <i class="fas fa-sign-out-alt action-icon"></i>
                <h3>Marcar Salida</h3>
                <p>Registra tu hora de salida</p>
                <button id="clockOutBtn" class="btn btn-danger" onclick="clockOut()">
                    <i class="fas fa-stop"></i> Salida
                </button>
            </div>
            
            <div class="action-card status">
                <i class="fas fa-chart-line action-icon"></i>
                <h3>Mi Estado</h3>
                <p>Ver resumen de asistencia</p>
                <button class="btn btn-info" onclick="showAttendanceStatus()">
                    <i class="fas fa-eye"></i> Ver Estado
                </button>
            </div>
        </div>
        
        <!-- Resumen de asistencia -->
        <div class="attendance-summary" id="attendanceSummary">
            <div class="summary-card">
                <div class="summary-value" id="todayHours">0.0</div>
                <div class="summary-label">Horas Hoy</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="weekHours">0.0</div>
                <div class="summary-label">Horas Esta Semana</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="monthHours">0.0</div>
                <div class="summary-label">Horas Este Mes</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="attendanceRate">100%</div>
                <div class="summary-label">Tasa de Asistencia</div>
            </div>
        </div>
        
        <!-- Historial de asistencia -->
        <div class="attendance-history">
            <h3><i class="fas fa-history"></i> Historial Reciente</h3>
            <table class="history-table" id="attendanceHistory">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Horas</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Navegación -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="../index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/attendance-functions.js"></script>
    
    <script>
        // Actualizar reloj cada segundo
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES');
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }
        
        // Cargar datos de asistencia
        async function loadAttendanceData() {
            try {
                // Obtener resumen
                const summary = await getAttendanceSummary();
                if (summary) {
                    document.getElementById('todayHours').textContent = '0.0'; // Se actualizará
                    document.getElementById('weekHours').textContent = summary.weekHours || '0.0';
                    document.getElementById('monthHours').textContent = summary.monthHours || '0.0';
                    document.getElementById('attendanceRate').textContent = (summary.attendanceRate || 100) + '%';
                }
                
                // Obtener historial
                const apiService = new ApiService();
                const attendance = await apiService.get('/attendance');
                if (attendance.success) {
                    displayAttendanceHistory(attendance.attendance.slice(0, 10)); // Últimos 10 registros
                }
                
                // Actualizar botones
                updateAttendanceButtons();
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        }
        
        // Mostrar historial en tabla
        function displayAttendanceHistory(records) {
            const tbody = document.getElementById('historyTableBody');
            
            if (!records || records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px;">
                            No hay registros de asistencia
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = records.map(record => {
                const date = new Date(record.created_at).toLocaleDateString('es-ES');
                const clockIn = record.clock_in ? new Date(record.clock_in).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '--';
                const clockOut = record.clock_out ? new Date(record.clock_out).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '--';
                const hours = record.total_hours ? parseFloat(record.total_hours).toFixed(1) : '--';
                
                let statusClass = 'status-present';
                let statusText = 'Presente';
                
                if (record.status === 'absent') {
                    statusClass = 'status-absent';
                    statusText = 'Ausente';
                } else if (record.status === 'late') {
                    statusClass = 'status-late';
                    statusText = 'Tardío';
                }
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${clockIn}</td>
                        <td>${clockOut}</td>
                        <td>${hours}h</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Mostrar estado de asistencia
        function showAttendanceStatus() {
            // Esta función se puede expandir para mostrar más detalles
            alert('Función de estado detallado en desarrollo');
        }
        
        // Verificar autenticación
        function checkAuth() {
            const user = window.authManager?.getCurrentUser();
            if (!user) {
                window.location.href = '../index.html';
                return false;
            }
            return true;
        }
        
        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            // Actualizar reloj inmediatamente y cada segundo
            updateClock();
            setInterval(updateClock, 1000);
            
            // Cargar datos de asistencia
            loadAttendanceData();
            
            // Recargar datos cada 5 minutos
            setInterval(loadAttendanceData, 5 * 60 * 1000);
        });
        
        // Función para mostrar notificaciones (simplificada)
        function showToast(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message); // Temporal - en producción usaría una librería de toast
        }
    </script>
</body>
</html>
