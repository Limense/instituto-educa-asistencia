<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Instituto Educa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/theme-educa.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-nav {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--color-primary);
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .nav-btn.secondary {
            background: var(--color-secondary);
        }

        .nav-btn.success {
            background: var(--color-success);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-primary);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .metric-label {
            color: var(--color-text-light);
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .metric-change.positive {
            color: var(--color-success);
        }

        .metric-change.negative {
            color: var(--color-danger);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container {
            height: 400px;
            position: relative;
        }

        .activity-feed {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
        }

        .activity-icon.success {
            background: var(--color-success);
        }

        .activity-icon.warning {
            background: var(--color-warning);
        }

        .activity-icon.danger {
            background: var(--color-danger);
        }

        .activity-icon.info {
            background: var(--color-info);
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-weight: bold;
            color: var(--color-text);
            margin-bottom: 5px;
        }

        .activity-time {
            color: var(--color-text-light);
            font-size: 0.9rem;
        }

        .recent-records {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: var(--color-light);
            font-weight: bold;
            color: var(--color-text);
        }

        .table tr:hover {
            background: var(--color-light);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-completed {
            background: var(--color-success);
            color: white;
        }

        .status-pending {
            background: var(--color-warning);
            color: white;
        }

        .status-absent {
            background: var(--color-danger);
            color: white;
        }

        .status-present {
            background: var(--color-info);
            color: white;
        }

        .quick-actions {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            background: var(--color-primary);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .action-btn.success {
            background: var(--color-success);
        }

        .action-btn.warning {
            background: var(--color-warning);
        }

        .action-btn.danger {
            background: var(--color-danger);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
            <p id="welcomeMessage">Bienvenido al Sistema de Asistencia</p>
            <div id="currentDateTime"></div>
        </div>

        <!-- Navegación rápida -->
        <div class="dashboard-nav">
            <h2><i class="fas fa-compass"></i> Navegación Rápida</h2>
            <div class="nav-buttons">
                <a href="attendance.html" class="nav-btn">
                    <i class="fas fa-clock"></i> Registro de Asistencia
                </a>
                <a href="reports.html" class="nav-btn secondary">
                    <i class="fas fa-chart-bar"></i> Reportes
                </a>
                <a href="admin.html" class="nav-btn success" id="adminLink" style="display: none;">
                    <i class="fas fa-cog"></i> Administración
                </a>
                <a href="../index.html" class="nav-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>

        <!-- Métricas principales -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalHours">0.0</div>
                <div class="metric-label">Horas del Mes</div>
                <div class="metric-change positive" id="hoursChange">+0% vs mes anterior</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="attendanceRate">0%</div>
                <div class="metric-label">Tasa de Asistencia</div>
                <div class="metric-change positive" id="attendanceChange">+0% vs mes anterior</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="presentDays">0</div>
                <div class="metric-label">Días Presente</div>
                <div class="metric-change" id="daysChange">de 0 días laborables</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="currentStatus">--</div>
                <div class="metric-label">Estado Actual</div>
                <div class="metric-change" id="statusTime">--</div>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="quick-actions">
            <h2><i class="fas fa-bolt"></i> Acciones Rápidas</h2>
            <div class="action-buttons">
                <button class="action-btn success" onclick="quickCheckIn()">
                    <i class="fas fa-sign-in-alt"></i> Entrada Rápida
                </button>
                <button class="action-btn danger" onclick="quickCheckOut()">
                    <i class="fas fa-sign-out-alt"></i> Salida Rápida
                </button>
                <button class="action-btn warning" onclick="quickBreak()">
                    <i class="fas fa-coffee"></i> Descanso
                </button>
                <button class="action-btn" onclick="viewMyReports()">
                    <i class="fas fa-file-alt"></i> Mis Reportes
                </button>
            </div>
        </div>

        <!-- Grid principal -->
        <div class="dashboard-grid">
            <!-- Gráfico de asistencia -->
            <div class="chart-section">
                <h2><i class="fas fa-chart-line"></i> Tendencia de Asistencia (Últimos 30 días)</h2>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <!-- Feed de actividad -->
            <div class="activity-feed">
                <h2><i class="fas fa-list"></i> Actividad Reciente</h2>
                <div id="activityList">
                    <div class="activity-item">
                        <div class="activity-icon info">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-title">Cargando actividad...</div>
                            <div class="activity-time">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registros recientes -->
        <div class="recent-records">
            <h2><i class="fas fa-table"></i> Registros Recientes</h2>
            <table class="table" id="recentRecordsTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Horas Trabajadas</th>
                        <th>Estado</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Cargando registros...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/data-factory.js"></script>
    <script src="../js/event-bus.js"></script>
    <script src="../js/services.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>
    <script>
        let currentUser = null;
        let attendanceChart = null;

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                window.location.href = '../index.html';
                return;
            }

            initializeDashboard();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setInterval(loadCurrentStatus, 30000); // Actualizar estado cada 30s
        });

        function initializeDashboard() {
            // Mostrar mensaje de bienvenida
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.textContent = `Bienvenido, ${currentUser.profile.firstName} ${currentUser.profile.lastName}`;

            // Mostrar link de admin si tiene permisos
            if (UserManager.hasPermission(currentUser.id, 'all_permissions') || 
                currentUser.role === 'administrator') {
                document.getElementById('adminLink').style.display = 'flex';
            }

            // Cargar datos
            loadDashboardMetrics();
            loadAttendanceChart();
            loadRecentRecords();
            loadActivityFeed();
            loadCurrentStatus();
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeStr = now.toLocaleString('es-PE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDateTime').textContent = dateTimeStr;
        }

        function loadDashboardMetrics() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const startDate = startOfMonth.toISOString().split('T')[0];
            const endDate = endOfMonth.toISOString().split('T')[0];

            // Obtener estadísticas del mes actual
            const stats = AttendanceManager.getAttendanceStatistics(currentUser.id, startDate, endDate);

            // Actualizar métricas
            document.getElementById('totalHours').textContent = stats.totalHours.toFixed(1);
            document.getElementById('attendanceRate').textContent = stats.attendanceRate + '%';
            document.getElementById('presentDays').textContent = stats.presentDays;

            // Calcular cambios respecto al mes anterior
            updateMetricChanges(stats);
        }

        function updateMetricChanges(currentStats) {
            // Obtener estadísticas del mes anterior para comparación
            const now = new Date();
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            
            const lastMonthStartDate = lastMonthStart.toISOString().split('T')[0];
            const lastMonthEndDate = lastMonthEnd.toISOString().split('T')[0];

            const lastMonthStats = AttendanceManager.getAttendanceStatistics(
                currentUser.id, lastMonthStartDate, lastMonthEndDate
            );

            // Calcular cambios porcentuales
            const hoursChange = lastMonthStats.totalHours > 0 ? 
                ((currentStats.totalHours - lastMonthStats.totalHours) / lastMonthStats.totalHours * 100) : 0;
            
            const attendanceChange = lastMonthStats.attendanceRate > 0 ? 
                (currentStats.attendanceRate - lastMonthStats.attendanceRate) : 0;

            // Actualizar elementos
            updateChangeElement('hoursChange', hoursChange, '%');
            updateChangeElement('attendanceChange', attendanceChange, 'pp');
            
            document.getElementById('daysChange').textContent = 
                `de ${currentStats.totalDays} días laborables`;
        }

        function updateChangeElement(elementId, change, unit) {
            const element = document.getElementById(elementId);
            const sign = change >= 0 ? '+' : '';
            const className = change >= 0 ? 'positive' : 'negative';
            
            element.textContent = `${sign}${change.toFixed(1)}${unit} vs mes anterior`;
            element.className = `metric-change ${className}`;
        }

        function loadCurrentStatus() {
            const today = new Date().toISOString().split('T')[0];
            const records = AttendanceManager.getAttendanceByUser(currentUser.id, today, today);
            const todayRecord = records[0];

            const statusElement = document.getElementById('currentStatus');
            const statusTimeElement = document.getElementById('statusTime');

            if (todayRecord && todayRecord.entries.length > 0) {
                const statusText = {
                    'present': 'Presente',
                    'on-break': 'En Descanso',
                    'completed': 'Completado',
                    'incomplete': 'Incompleto',
                    'absent': 'Ausente'
                };

                statusElement.textContent = statusText[todayRecord.status] || 'Desconocido';
                
                const lastEntry = todayRecord.entries[todayRecord.entries.length - 1];
                if (lastEntry) {
                    statusTimeElement.textContent = `desde ${lastEntry.time}`;
                } else {
                    statusTimeElement.textContent = '--';
                }
            } else {
                statusElement.textContent = 'Sin registros';
                statusTimeElement.textContent = 'hoy';
            }
        }

        function loadAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            // Obtener datos de los últimos 30 días
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 29);

            const records = AttendanceManager.getAttendanceByUser(
                currentUser.id, 
                startDate.toISOString().split('T')[0], 
                endDate.toISOString().split('T')[0]
            );

            const labels = [];
            const data = [];

            // Preparar datos para el gráfico
            for (let i = 0; i < 30; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit' }));
                
                const record = records.find(r => r.date === dateStr);
                data.push(record ? (record.totalHours || 0) : 0);
            }

            if (attendanceChart) {
                attendanceChart.destroy();
            }

            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Trabajadas',
                        data: data,
                        borderColor: 'rgb(242, 121, 131)',
                        backgroundColor: 'rgba(242, 121, 131, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 12
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function loadRecentRecords() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 7); // Últimos 7 días

            const records = AttendanceManager.getAttendanceByUser(
                currentUser.id,
                startDate.toISOString().split('T')[0],
                endDate.toISOString().split('T')[0]
            );

            const tbody = document.querySelector('#recentRecordsTable tbody');
            
            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            No hay registros recientes
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.slice(-10).reverse().map(record => {
                const firstEntry = record.entries.find(e => e.type === 'check-in');
                const lastExit = record.entries.reverse().find(e => e.type === 'check-out');
                record.entries.reverse(); // Restaurar orden original

                const observations = record.observations.length > 0 ? 
                    record.observations.map(obs => obs.message).join(', ') : 'Ninguna';

                return `
                    <tr>
                        <td>${formatDate(record.date)}</td>
                        <td>${firstEntry ? firstEntry.time : '--'}</td>
                        <td>${lastExit ? lastExit.time : '--'}</td>
                        <td>${(record.totalHours || 0).toFixed(1)}h</td>
                        <td>${getStatusBadge(record.status)}</td>
                        <td>${observations}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadActivityFeed() {
            const container = document.getElementById('activityList');
            const activities = getRecentActivities();

            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon info">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-title">No hay actividad reciente</div>
                            <div class="activity-time">--</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">
                        <i class="fas fa-${activity.icon}"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                </div>
            `).join('');
        }

        function getRecentActivities() {
            const activities = [];
            
            // Obtener registros de hoy
            const today = new Date().toISOString().split('T')[0];
            const records = AttendanceManager.getAttendanceByUser(currentUser.id, today, today);
            const todayRecord = records[0];

            if (todayRecord) {
                // Agregar entradas de hoy
                [...todayRecord.entries, ...todayRecord.breaks].forEach(entry => {
                    const typeMap = {
                        'check-in': { title: 'Entrada registrada', icon: 'sign-in-alt', type: 'success' },
                        'check-out': { title: 'Salida registrada', icon: 'sign-out-alt', type: 'danger' },
                        'break-start': { title: 'Inicio de descanso', icon: 'coffee', type: 'warning' },
                        'break-end': { title: 'Fin de descanso', icon: 'play', type: 'info' }
                    };

                    const typeInfo = typeMap[entry.type];
                    if (typeInfo) {
                        activities.push({
                            title: typeInfo.title,
                            time: entry.time,
                            icon: typeInfo.icon,
                            type: typeInfo.type
                        });
                    }
                });

                // Agregar observaciones
                todayRecord.observations.forEach(obs => {
                    activities.push({
                        title: obs.message,
                        time: new Date(obs.timestamp).toLocaleTimeString('es-PE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        icon: 'comment',
                        type: obs.severity === 'high' ? 'danger' : 'warning'
                    });
                });
            }

            // Ordenar por timestamp y limitar a 5
            return activities.slice(-5).reverse();
        }

        // Funciones de acciones rápidas
        function quickCheckIn() {
            try {
                AttendanceManager.recordAttendance(currentUser.id, 'check-in', {
                    method: 'manual',
                    location: 'Dashboard'
                });
                showNotification('Entrada registrada correctamente', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function quickCheckOut() {
            try {
                AttendanceManager.recordAttendance(currentUser.id, 'check-out', {
                    method: 'manual',
                    location: 'Dashboard'
                });
                showNotification('Salida registrada correctamente', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function quickBreak() {
            const today = new Date().toISOString().split('T')[0];
            const records = AttendanceManager.getAttendanceByUser(currentUser.id, today, today);
            const todayRecord = records[0];

            try {
                const type = todayRecord && todayRecord.status === 'on-break' ? 'break-end' : 'break-start';
                AttendanceManager.recordAttendance(currentUser.id, type, {
                    method: 'manual',
                    location: 'Dashboard'
                });
                showNotification('Descanso registrado correctamente', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function viewMyReports() {
            window.location.href = 'reports.html?user=' + currentUser.id;
        }

        function logout() {
            AuthManager.logout();
        }

        // Funciones de utilidad
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getStatusBadge(status) {
            const statusMap = {
                'present': { text: 'Presente', class: 'status-present' },
                'absent': { text: 'Ausente', class: 'status-absent' },
                'completed': { text: 'Completado', class: 'status-completed' },
                'incomplete': { text: 'Pendiente', class: 'status-pending' },
                'on-break': { text: 'Descanso', class: 'status-pending' }
            };

            const statusInfo = statusMap[status] || { text: status, class: 'status-pending' };
            return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function showNotification(message, type) {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--color-success)' : 'var(--color-danger)'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: bold;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
    </div>

    <script src="../js/dashboard.js"></script>
</body>
</html>