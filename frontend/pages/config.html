<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración del Sistema - Instituto Educa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .config-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .config-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .config-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .config-tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .config-tab.active {
            background: #f8f9ff;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .config-tab:hover {
            background: #f8f9ff;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .system-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
        }

        .info-value {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                Instituto Educa
            </div>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    Inicio
                </a>
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
                <a href="supervisor.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    Supervisor
                </a>
                <a href="#" class="nav-link active">
                    <i class="fas fa-cog"></i>
                    Configuración
                </a>
                <button id="logoutBtn" class="nav-link logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </nav>

    <div class="config-container">
        <div class="config-header">
            <h1><i class="fas fa-cog"></i> Configuración del Sistema</h1>
            <p>Administra la configuración global del sistema de asistencia</p>
        </div>

        <div class="alert alert-success" id="successAlert">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage"></span>
        </div>

        <div class="alert alert-error" id="errorAlert">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMessage"></span>
        </div>

        <div class="config-tabs">
            <button class="config-tab active" data-tab="general">
                <i class="fas fa-cog"></i>
                General
            </button>
            <button class="config-tab" data-tab="security">
                <i class="fas fa-shield-alt"></i>
                Seguridad
            </button>
            <button class="config-tab" data-tab="notifications">
                <i class="fas fa-bell"></i>
                Notificaciones
            </button>
            <button class="config-tab" data-tab="system">
                <i class="fas fa-server"></i>
                Sistema
            </button>
        </div>

        <!-- Tab General -->
        <div class="tab-content active" id="general-tab">
            <h3><i class="fas fa-cog"></i> Configuración General</h3>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label for="instituteName">Nombre de la Institución</label>
                    <input type="text" id="instituteName" placeholder="Instituto Educa">
                </div>

                <div class="form-group">
                    <label for="instituteAddress">Dirección</label>
                    <input type="text" id="instituteAddress" placeholder="Dirección de la institución">
                </div>

                <div class="form-group">
                    <label for="institutePhone">Teléfono</label>
                    <input type="tel" id="institutePhone" placeholder="Número de teléfono">
                </div>

                <div class="form-group">
                    <label for="instituteEmail">Email</label>
                    <input type="email" id="instituteEmail" placeholder="correo@instituto.edu">
                </div>

                <div class="form-group">
                    <label for="workingHours">Horario de Trabajo</label>
                    <select id="workingHours">
                        <option value="8-17">8:00 AM - 5:00 PM</option>
                        <option value="9-18">9:00 AM - 6:00 PM</option>
                        <option value="7-16">7:00 AM - 4:00 PM</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="timezone">Zona Horaria</label>
                    <select id="timezone">
                        <option value="America/Mexico_City">Ciudad de México (GMT-6)</option>
                        <option value="America/Bogota">Bogotá (GMT-5)</option>
                        <option value="America/Lima">Lima (GMT-5)</option>
                        <option value="America/Santiago">Santiago (GMT-3)</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveGeneralSettings()">
                <i class="fas fa-save"></i>
                Guardar Configuración
            </button>
        </div>

        <!-- Tab Seguridad -->
        <div class="tab-content" id="security-tab">
            <h3><i class="fas fa-shield-alt"></i> Configuración de Seguridad</h3>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label for="sessionTimeout">Tiempo de Sesión (minutos)</label>
                    <input type="number" id="sessionTimeout" min="5" max="480" value="60">
                </div>

                <div class="form-group">
                    <label for="maxLoginAttempts">Máximo Intentos de Login</label>
                    <input type="number" id="maxLoginAttempts" min="3" max="10" value="5">
                </div>

                <div class="form-group">
                    <label for="passwordPolicy">Política de Contraseñas</label>
                    <select id="passwordPolicy">
                        <option value="basic">Básica (6 caracteres)</option>
                        <option value="medium">Media (8 caracteres, números)</option>
                        <option value="strong">Fuerte (8 caracteres, números, símbolos)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="twoFactorAuth">Autenticación de Dos Factores</label>
                    <select id="twoFactorAuth">
                        <option value="disabled">Deshabilitada</option>
                        <option value="optional">Opcional</option>
                        <option value="required">Requerida</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveSecuritySettings()">
                <i class="fas fa-save"></i>
                Guardar Configuración
            </button>
        </div>

        <!-- Tab Notificaciones -->
        <div class="tab-content" id="notifications-tab">
            <h3><i class="fas fa-bell"></i> Configuración de Notificaciones</h3>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label for="emailNotifications">
                        <input type="checkbox" id="emailNotifications" checked>
                        Notificaciones por Email
                    </label>
                </div>

                <div class="form-group">
                    <label for="smsNotifications">
                        <input type="checkbox" id="smsNotifications">
                        Notificaciones por SMS
                    </label>
                </div>

                <div class="form-group">
                    <label for="notifyAbsences">
                        <input type="checkbox" id="notifyAbsences" checked>
                        Notificar Ausencias
                    </label>
                </div>

                <div class="form-group">
                    <label for="notifyLateArrivals">
                        <input type="checkbox" id="notifyLateArrivals" checked>
                        Notificar Llegadas Tardías
                    </label>
                </div>

                <div class="form-group">
                    <label for="notificationTime">Hora de Notificaciones Diarias</label>
                    <input type="time" id="notificationTime" value="18:00">
                </div>

                <div class="form-group">
                    <label for="smtpServer">Servidor SMTP</label>
                    <input type="text" id="smtpServer" placeholder="smtp.gmail.com">
                </div>

                <div class="form-group">
                    <label for="smtpPort">Puerto SMTP</label>
                    <input type="number" id="smtpPort" value="587">
                </div>

                <div class="form-group">
                    <label for="smtpUser">Usuario SMTP</label>
                    <input type="email" id="smtpUser" placeholder="correo@instituto.edu">
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                <i class="fas fa-save"></i>
                Guardar Configuración
            </button>
        </div>

        <!-- Tab Sistema -->
        <div class="tab-content" id="system-tab">
            <h3><i class="fas fa-server"></i> Información del Sistema</h3>
            
            <div class="system-info">
                <div class="info-item">
                    <span class="info-label">Versión del Sistema:</span>
                    <span class="info-value">2.0.0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Base de Datos:</span>
                    <span class="info-value" id="dbStatus">Conectando...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Servidor:</span>
                    <span class="info-value" id="serverStatus">Conectando...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Última Actualización:</span>
                    <span class="info-value" id="lastUpdate">Verificando...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total de Usuarios:</span>
                    <span class="info-value" id="totalUsers">Cargando...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Registros de Asistencia (Este Mes):</span>
                    <span class="info-value" id="monthlyAttendance">Cargando...</span>
                </div>
            </div>

            <div class="settings-grid">
                <button class="btn btn-secondary" onclick="checkSystemHealth()">
                    <i class="fas fa-heartbeat"></i>
                    Verificar Estado del Sistema
                </button>

                <button class="btn btn-primary" onclick="exportSystemData()">
                    <i class="fas fa-download"></i>
                    Exportar Datos del Sistema
                </button>

                <button class="btn btn-secondary" onclick="clearSystemCache()">
                    <i class="fas fa-broom"></i>
                    Limpiar Caché
                </button>

                <button class="btn btn-success" onclick="optimizeDatabase()">
                    <i class="fas fa-database"></i>
                    Optimizar Base de Datos
                </button>
            </div>
        </div>
    </div>

    <script src="../js/api-service.js"></script>
    <script src="../js/data-factory.js"></script>
    <script src="../js/event-bus.js"></script>
    <script src="../js/services.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // Sistema de configuración moderno - Solo API, sin localStorage
        class ConfigManager {
            constructor() {
                this.currentSettings = {};
                this.init();
            }

            async init() {
                await this.loadSettings();
                this.setupEventListeners();
                this.loadSystemInfo();
            }

            setupEventListeners() {
                // Tabs
                document.querySelectorAll('.config-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (window.AuthManager) {
                        window.AuthManager.logout();
                    }
                    window.location.href = '../index.html';
                });
            }

            switchTab(tabName) {
                // Actualizar tabs
                document.querySelectorAll('.config-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Actualizar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            async loadSettings() {
                try {
                    const response = await window.ApiService.get('/settings');
                    this.currentSettings = response.data || {};
                    this.populateForm();
                } catch (error) {
                    console.error('Error cargando configuración:', error);
                    this.showAlert('error', 'Error al cargar la configuración');
                }
            }

            populateForm() {
                // Configuración general
                document.getElementById('instituteName').value = this.currentSettings.instituteName || 'Instituto Educa';
                document.getElementById('instituteAddress').value = this.currentSettings.instituteAddress || '';
                document.getElementById('institutePhone').value = this.currentSettings.institutePhone || '';
                document.getElementById('instituteEmail').value = this.currentSettings.instituteEmail || '';
                document.getElementById('workingHours').value = this.currentSettings.workingHours || '8-17';
                document.getElementById('timezone').value = this.currentSettings.timezone || 'America/Mexico_City';

                // Configuración de seguridad
                document.getElementById('sessionTimeout').value = this.currentSettings.sessionTimeout || 60;
                document.getElementById('maxLoginAttempts').value = this.currentSettings.maxLoginAttempts || 5;
                document.getElementById('passwordPolicy').value = this.currentSettings.passwordPolicy || 'medium';
                document.getElementById('twoFactorAuth').value = this.currentSettings.twoFactorAuth || 'disabled';

                // Configuración de notificaciones
                document.getElementById('emailNotifications').checked = this.currentSettings.emailNotifications !== false;
                document.getElementById('smsNotifications').checked = this.currentSettings.smsNotifications || false;
                document.getElementById('notifyAbsences').checked = this.currentSettings.notifyAbsences !== false;
                document.getElementById('notifyLateArrivals').checked = this.currentSettings.notifyLateArrivals !== false;
                document.getElementById('notificationTime').value = this.currentSettings.notificationTime || '18:00';
                document.getElementById('smtpServer').value = this.currentSettings.smtpServer || '';
                document.getElementById('smtpPort').value = this.currentSettings.smtpPort || 587;
                document.getElementById('smtpUser').value = this.currentSettings.smtpUser || '';
            }

            async loadSystemInfo() {
                try {
                    const healthResponse = await window.ApiService.get('/health');
                    document.getElementById('serverStatus').textContent = 'Conectado';
                    document.getElementById('dbStatus').textContent = 'Conectado';

                    const usersResponse = await window.ApiService.get('/users');
                    document.getElementById('totalUsers').textContent = usersResponse.data?.length || 0;

                    const attendanceResponse = await window.ApiService.get('/attendance');
                    const currentMonth = new Date().getMonth();
                    const monthlyCount = attendanceResponse.data?.filter(record => 
                        new Date(record.date).getMonth() === currentMonth
                    ).length || 0;
                    document.getElementById('monthlyAttendance').textContent = monthlyCount;

                    document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
                } catch (error) {
                    console.error('Error cargando información del sistema:', error);
                    document.getElementById('serverStatus').textContent = 'Error';
                    document.getElementById('dbStatus').textContent = 'Error';
                }
            }

            showAlert(type, message) {
                const alertElement = document.getElementById(type === 'error' ? 'errorAlert' : 'successAlert');
                const messageElement = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
                
                messageElement.textContent = message;
                alertElement.classList.add('show');
                
                setTimeout(() => {
                    alertElement.classList.remove('show');
                }, 5000);
            }

            collectFormData(category) {
                const data = {};
                
                if (category === 'general') {
                    data.instituteName = document.getElementById('instituteName').value;
                    data.instituteAddress = document.getElementById('instituteAddress').value;
                    data.institutePhone = document.getElementById('institutePhone').value;
                    data.instituteEmail = document.getElementById('instituteEmail').value;
                    data.workingHours = document.getElementById('workingHours').value;
                    data.timezone = document.getElementById('timezone').value;
                } else if (category === 'security') {
                    data.sessionTimeout = parseInt(document.getElementById('sessionTimeout').value);
                    data.maxLoginAttempts = parseInt(document.getElementById('maxLoginAttempts').value);
                    data.passwordPolicy = document.getElementById('passwordPolicy').value;
                    data.twoFactorAuth = document.getElementById('twoFactorAuth').value;
                } else if (category === 'notifications') {
                    data.emailNotifications = document.getElementById('emailNotifications').checked;
                    data.smsNotifications = document.getElementById('smsNotifications').checked;
                    data.notifyAbsences = document.getElementById('notifyAbsences').checked;
                    data.notifyLateArrivals = document.getElementById('notifyLateArrivals').checked;
                    data.notificationTime = document.getElementById('notificationTime').value;
                    data.smtpServer = document.getElementById('smtpServer').value;
                    data.smtpPort = parseInt(document.getElementById('smtpPort').value);
                    data.smtpUser = document.getElementById('smtpUser').value;
                }
                
                return data;
            }

            async saveSettings(category) {
                try {
                    const newSettings = this.collectFormData(category);
                    this.currentSettings = { ...this.currentSettings, ...newSettings };
                    
                    await window.ApiService.post('/settings', this.currentSettings);
                    this.showAlert('success', 'Configuración guardada correctamente');
                } catch (error) {
                    console.error('Error guardando configuración:', error);
                    this.showAlert('error', 'Error al guardar la configuración');
                }
            }
        }

        // Funciones globales para los botones
        async function saveGeneralSettings() {
            await window.configManager.saveSettings('general');
        }

        async function saveSecuritySettings() {
            await window.configManager.saveSettings('security');
        }

        async function saveNotificationSettings() {
            await window.configManager.saveSettings('notifications');
        }

        async function checkSystemHealth() {
            try {
                await window.ApiService.get('/health');
                window.configManager.showAlert('success', 'Sistema funcionando correctamente');
                window.configManager.loadSystemInfo();
            } catch (error) {
                window.configManager.showAlert('error', 'Error en el sistema');
            }
        }

        async function exportSystemData() {
            try {
                const users = await window.ApiService.get('/users');
                const attendance = await window.ApiService.get('/attendance');
                const settings = await window.ApiService.get('/settings');
                
                const exportData = {
                    users: users.data,
                    attendance: attendance.data,
                    settings: settings.data,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `educa_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                window.configManager.showAlert('success', 'Datos exportados correctamente');
            } catch (error) {
                window.configManager.showAlert('error', 'Error al exportar datos');
            }
        }

        async function clearSystemCache() {
            // Simular limpieza de caché
            window.configManager.showAlert('success', 'Caché del sistema limpiado');
        }

        async function optimizeDatabase() {
            // Simular optimización de base de datos
            window.configManager.showAlert('success', 'Base de datos optimizada');
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            window.configManager = new ConfigManager();
        });
    </script>
</body>
</html>